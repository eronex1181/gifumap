<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Noto CSMap（検索ラベル・クラスタ同期・土砂災害・地価〈令和7年〉）</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.9/dist/leaflet-search.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
<style>
  html,body{height:100%;margin:0}
  #map{height:100%;background:#f3f3f3}
  .legend{background:#fff;padding:6px 10px;line-height:18px;box-shadow:0 0 15px rgba(0,0,0,.2)}
  .legend i{width:18px;height:18px;float:left;margin-right:8px;opacity:.9}
  .bus-icon{font-size:22px;width:26px;height:26px;line-height:26px;text-align:center;transform:translate(-13px,-13px);text-shadow:0 0 2px rgba(255,255,255,.85)}
  #msg{position:absolute;left:0;right:0;top:8px;text-align:center;color:#666;font:14px/1.6 system-ui;z-index:9999}
  .search-tag{display:inline-block;margin:6px 6px 4px 6px;padding:2px 8px;border-radius:999px;font-size:12px;color:#fff;background:#607d8b;line-height:1.4;vertical-align:middle}
</style>
</head>
<body>
<div id="map"></div>
<div id="msg">地図を初期化中…</div>

<script>
function loadScript(src){return new Promise((ok,ng)=>{const s=document.createElement('script');s.src=src;s.onload=ok;s.onerror=ng;document.head.appendChild(s);});}
(async()=>{
  try{ await loadScript("https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"); }
  catch{ try{ await loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"); }
         catch{ await loadScript("https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"); } }
  await loadScript("https://cdn.jsdelivr.net/npm/leaflet-search@3.0.9/dist/leaflet-search.min.js");
  await loadScript("https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.js");
  await loadScript("https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js");
  init();
})();

function init(){
  const msg = document.getElementById('msg'); if (msg) msg.remove();
  const map = L.map('map').setView([37.3,136.9],11);

  // --- panes ---
  map.createPane('boundaryPane');  map.getPane('boundaryPane').style.zIndex = 421;
  map.createPane('palePane');      map.getPane('palePane').style.zIndex = 425;
  map.createPane('zonesPane');     map.getPane('zonesPane').style.zIndex = 428;
  map.createPane('markersPane');   map.getPane('markersPane').style.zIndex = 430;

  // --- base layers ---
  const baseNoto = L.tileLayer('https://rinya.geospatial.jp/tile/csmaptile_noto/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© 林野庁'}).addTo(map);
  const gsiPale  = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png',{maxZoom:18,opacity:.6,pane:'palePane',attribution:'© 国土地理院'});
  const ctl = L.control.layers({'Noto CSMap':baseNoto},{'国土地理院地図':gsiPale},{collapsed:false}).addTo(map);
  L.control.scale({position:'bottomleft',imperial:false}).addTo(map);

  // ---- helpers ----
  const z2h = s => (s ?? '').toString().replace(/[！-～]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/\s+/g,' ').trim();
  const normKey = k => z2h(k).replace(/[ \t\r\n]/g,'').replace(/[／\/]/g,'/').replace(/[％%]/g,'%').replace(/[㎡m2]/g,'m2').toLowerCase();
  const pickKey = (obj, keysOrRegs) => {
    if (!obj) return '';
    const m = new Map(Object.keys(obj).map(k=>[normKey(k),k]));
    for(const k of keysOrRegs){ if(typeof k==='string'){ const nk=normKey(k); if(m.has(nk)) return obj[m.get(nk)]; } }
    const entries = Object.keys(obj).map(k=>[k,normKey(k)]);
    for(const r of keysOrRegs){ if(r instanceof RegExp){ const hit=entries.find(([,nk])=>r.test(nk)); if(hit) return obj[hit[0]]; } }
    return '';
  };
  const nf = new Intl.NumberFormat('ja-JP');
  const fmtYen = v=>{ if(v==null||v==='') return '-'; const n=Number(String(v).replace(/[,円¥\s]|\/?\s*m2/gi,'')); return Number.isFinite(n)?nf.format(n)+'円/㎡':String(v); };
  const fmtPct = v=>{ if(v==null||v==='') return '-'; const n=Number(String(v).replace(/[,\s%％]/g,'')); return Number.isFinite(n)?n.toFixed(1)+'%':String(v); };
  const addTag=(ctrl,label,color)=>{ ctrl.options.collapsed=false; const el=ctrl._container||ctrl.getContainer();
    const tag=document.createElement('span'); tag.className='search-tag'; tag.textContent=label; if(color) tag.style.background=color;
    (el.querySelector('form')||el).insertBefore(tag,el.firstChild); return ctrl; };

  // --- クラスタと子レイヤーを常に同期させるヘルパ ---
  function registerClusterOverlay(name, srcLayer, options){
    const cluster = L.markerClusterGroup(Object.assign({
      pane:'markersPane', disableClusteringAtZoom:16, spiderfyOnMaxZoom:true, showCoverageOnHover:false
    }, options||{}));
    cluster.addLayer(srcLayer);
    // 念のため子を map から除去（誤って addTo された場合でも残らない）
    if(map.hasLayer(srcLayer)) map.removeLayer(srcLayer);

    // 初期ON
    map.addLayer(cluster);
    ctl.addOverlay(cluster, name);

    // トグル時に必ず子も外す/戻す
    map.on('overlayremove', e => { if(e.layer===cluster){ if(map.hasLayer(srcLayer)) map.removeLayer(srcLayer); } });
    map.on('overlayadd',    e => { if(e.layer===cluster){ if(!cluster.hasLayer(srcLayer)) cluster.addLayer(srcLayer); } });

    return cluster;
  }

  // ===== 大字（初期ON） =====
  fetch('./kyoukai.geojson',{cache:'no-store'}).then(r=>r.json()).then(data=>{
    const boundaryLayer = L.geoJSON(data,{
      pane:'boundaryPane',
      style:()=>({color:'green',dashArray:'4,4',weight:1.5,opacity:1}),
      onEachFeature:(f,l)=>{const p=f.properties??{}; l.options.title=z2h(`${p['大字']??''} ${p['市町村']??''}`);
        l.bindPopup(`<b>大字:</b> ${p['大字']??'-'}<br><b>市町村:</b> ${p['市町村']??'-'}`);}
    }).addTo(map);
    ctl.addOverlay(boundaryLayer,'大字境界');

    const s1 = new L.Control.Search({layer: boundaryLayer, propertyName:'大字', textPlaceholder:'大字名', marker:false, zoom:14, collapsed:false}).addTo(map);
    addTag(s1,'📚 大字','#2e7d32');
  });

  // ===== 指定避難場所（初期ON・クラスタ同期） =====
  fetch('./17000_1.geojson',{cache:'no-store'}).then(r=>r.json()).then(data=>{
    const icon = L.icon({iconUrl:'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-green.png',
                         iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-35]});
    const shelters = L.geoJSON(data,{
      pane:'markersPane',
      pointToLayer:(f,latlng)=>{ const p=f.properties??{}; p._shelter_name = p['施設・場所名'] ?? p['名称'] ?? '';
        const m=L.marker(latlng,{icon}); m.options.title=p._shelter_name; return m; },
      onEachFeature:(f,l)=>l.bindPopup(`<b>指定避難場所</b><br>${Object.entries(f.properties??{}).map(([k,v])=>`<b>${k}:</b> ${v}`).join('<br>')}`)
    });
    const cluster = registerClusterOverlay('指定避難場所（更新：令和7年7月9日）', shelters);

    const s3 = new L.Control.Search({layer: shelters, propertyName:'_shelter_name', textPlaceholder:'施設・場所名', marker:false, zoom:17, collapsed:false}).addTo(map);
    addTag(s3,'🏠 避難所','#388e3c');
    s3.on('search:locationfound', e=>{ if(e.latlng) map.setView(e.latlng, Math.max(map.getZoom(),17)); if(e.layer.openPopup) e.layer.openPopup(); });
  });

  // ===== ため池（初期ON・クラスタ同期） =====
  fetch('./ため池.geojson',{cache:'no-store'}).then(r=>r.json()).then(data=>{
    const icon = L.icon({iconUrl:'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-blue.png',
                         iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-35]});
    const ponds = L.geoJSON(data,{
      pane:'markersPane',
      pointToLayer:(f,latlng)=>{ const p=f.properties??{}; p._pond_name = p.name ?? p['名称'] ?? p['Name'] ?? '';
        const m=L.marker(latlng,{icon}); m.options.title=p._pond_name; return m; },
      onEachFeature:(f,l)=>{ const p=f.properties??{}, nm=p._pond_name ?? ''; const skip=new Set(['name','名称','Name']);
        const rest=Object.entries(p).filter(([k])=>!skip.has(k) && k!=='_pond_name').map(([k,v])=>`<b>${k}:</b> ${v}`).join('<br>');
        l.bindPopup(`<b>ため池</b>${nm?`<br><b>name:</b> ${nm}`:''}${rest?`<br>${rest}`:''}`); }
    });
    registerClusterOverlay('ため池', ponds);

    const s4 = new L.Control.Search({layer: ponds, propertyName:'_pond_name', textPlaceholder:'ため池名', marker:false, zoom:18, collapsed:false}).addTo(map);
    addTag(s4,'💧 ため池','#1976d2');
    s4.on('search:locationfound', e=>{ if(e.latlng) map.setView(e.latlng, Math.max(map.getZoom(),18)); if(e.layer.openPopup) e.layer.openPopup(); });
  });

  // ===== バス停（初期ON・クラスタ同期） =====
  fetch('./P11-22_17.geojson?_=now',{cache:'no-store'}).then(r=>r.json()).then(data=>{
    const ic = L.divIcon({html:'🚌',className:'bus-icon',iconSize:[26,26],iconAnchor:[13,13],popupAnchor:[0,-12]});
    const pickName = (p)=>{const ks=['名称','停留所名','バス停名','name','Name','停名','停留所']; for(const k of ks){ if(p&&p[k]) return z2h(p[k]);} for(const [k,v] of Object.entries(p??{})){ if(typeof v==='string'&&v.trim()) return z2h(v);} return '';};
    const buses = L.geoJSON(data,{
      pane:'markersPane',
      pointToLayer:(f,latlng)=>{ const p=f.properties??{}; p._bus_name = pickName(p); const m=L.marker(latlng,{icon:ic}); m.options.title=p._bus_name; return m; },
      onEachFeature:(f,l)=>{ const p=f.properties??{}, n=p._bus_name ?? ''; const skip=new Set(['名称','停留所名','バス停名','name','Name','停名','停留所']);
        const rest=Object.entries(p).filter(([k])=>!skip.has(k) && k!=='_bus_name').map(([k,v])=>`<b>${k}:</b> ${v}`).join('<br>');
        l.bindPopup(`<b>バス停（令和4年）</b>${n?`<br><b>名称:</b> ${n}`:''}${rest?`<br>${rest}`:''}`); }
    });
    registerClusterOverlay('バス停（令和4年）', buses);

    const s5 = new L.Control.Search({layer: buses, propertyName:'_bus_name', textPlaceholder:'バス停名', marker:false, zoom:18, collapsed:false}).addTo(map);
    addTag(s5,'🚌 バス停','#6a1b9a');
    s5.on('search:locationfound', e=>{ if(e.latlng) map.setView(e.latlng, Math.max(map.getZoom(),18)); if(e.layer.openPopup) e.layer.openPopup(); });
  });

  // ===== 地価（令和7年・石川／検索UIなし・クラスタ同期） =====
  fetch('./石川地価2025.geojson?_=r7',{cache:'no-store'}).then(r=>r.json()).then(data=>{
    const icon = L.icon({iconUrl:'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-orange.png',
                         shadowUrl:'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-shadow.png',
                         iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[0,-35]});
    const land = L.geoJSON(data,{
      pane:'markersPane',
      pointToLayer:(f,latlng)=>{
        const p=f.properties??{};
        const city  = pickKey(p,['市区町村名','市町村','市区町村','基準地の地名','所在地市区町村',/市区町村/]);
        const where = pickKey(p,['所在地','所在地並びに地番','住居表示','地番','地点名','地区名',/所在地/]);
        const no    = pickKey(p,['標準地番号','標準地番号（コード）','地点番号','番号',/標準地/]);
        p._label = z2h([city,(where||no)].filter(Boolean).join(' ')) || z2h(no) || z2h(where) || '地価調査地点';
        const m=L.marker(latlng,{icon}); m.options.title=p._label; return m;
      },
      onEachFeature:(f,l)=>{
        const p=f.properties??{};
        const price = fmtYen(pickKey(p,['価格','価格（円/㎡）','価格_円m2','価格_円／㎡','単価','price','円/m2','円／m2','円/㎡','円／㎡','円m2',/円.?m2/]));
        const yoy   = fmtPct(pickKey(p,['対前年変動率','対前年変動率（％）','対前年変動率%','対前年変動率％','変動率','前年比','前年比％','yoy',/対前年.*変動率/,/前年比/]));
        const use   = pickKey(p,['用途','用途区分','区分','用途地域',/用途/]);
        const city  = pickKey(p,['市区町村名','市町村','市区町村','基準地の地名','所在地市区町村',/市区町村/]);
        const where = pickKey(p,['所在地','所在地並びに地番','住居表示','地番','地点名','地区名',/所在地/]);
        const no    = pickKey(p,['標準地番号','標準地番号（コード）','地点番号','番号',/標準地/]);
        const note  = pickKey(p,['備考','注記','メモ']);
        let html =
          `<b>地価調査（令和7年）</b><br>`+
          `<b>標準地番号:</b> ${no||'-'}<br>`+
          `<b>所在地:</b> ${[city,where].filter(Boolean).join(' ')||'-'}<br>`+
          `<b>用途:</b> ${use||'-'}<br>`+
          `<b>価格:</b> ${price}<br>`+
          `<b>対前年変動率:</b> ${yoy}`;
        if(price==='-'&&yoy==='-'&&!no&&!city&&!where){
          const rows=Object.entries(p).map(([k,v])=>`<tr><th style="text-align:left;padding-right:6px;">${k}</th><td>${v}</td></tr>`).join('');
          html+=`<br><div style="max-height:240px;overflow:auto;"><table>${rows}</table></div>`;
        }
        if(note) html+=`<br><b>備考:</b> ${note}`;
        l.bindPopup(html);
      }
    });
    registerClusterOverlay('地価調査（令和7年・石川）', land);
  });

  // ===== 土砂災害（初期ON・一番下） =====
  fetch('./dosya.geojson',{cache:'no-store'}).then(r=>r.json()).then(data=>{
    const col=v=>(v==1||v==='1')?'#ffff00':(v==2||v==='2')?'#ff0000':'#888';
    const nm=v=>(v==1||v==='1')?'イエローゾーン':(v==2||v==='2')?'レッドゾーン':'その他';
    const danger = L.geoJSON(data,{
      pane:'zonesPane',
      style:f=>({color:col(f.properties.A33_002),weight:2,opacity:.9,fillOpacity:.25}),
      onEachFeature:(f,l)=>{
        const p=f.properties??{}; const num=(p.A33_004??'').toString().split(/[-－―‐]/)[0].replace(/\D/g,''); const name=(p.A33_005??'').toString();
        l.options.title=`${num} ${name}`.trim();
        l.bindPopup(`<b>${nm(p.A33_002)}</b><br><b>箇所番号:</b> ${p.A33_004??'-'}<br><b>箇所名:</b> ${p.A33_005??'-'}`+(p.A33_009?`<br><b>市町村:</b> ${p.A33_009}`:''));
      }
    }).addTo(map);
    ctl.addOverlay(danger,'土砂災害警戒区域');

    const s2 = new L.Control.Search({layer: danger, propertyName:'title', textPlaceholder:'箇所番号 / 箇所名', marker:false, zoom:16, collapsed:false}).addTo(map);
    addTag(s2,'⚠️ 土砂災害','#e53935');
  });

  // 凡例
  const legend=L.control({position:'bottomright'});
  legend.onAdd=()=>{const d=L.DomUtil.create('div','legend'); d.innerHTML =
    '<i style="background:#ffff00;"></i> イエローゾーン<br>'+
    '<i style="background:#ff0000;"></i> レッドゾーン<br>'+
    '<img src="https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-green.png" style="height:18px;vertical-align:middle;margin-right:6px;"> 指定避難場所（令和7年7月9日）<br>'+
    '<img src="https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-blue.png" style="height:18px;vertical-align:middle;margin-right:6px;"> ため池<br>'+
    '<span style="font-size:18px;vertical-align:middle;margin-right:6px;">🚌</span> バス停（令和4年）<br>'+
    '<img src="https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-orange.png" style="height:18px;vertical-align:middle;margin-right:6px;"> 地価調査（令和7年）';
    return d;};
  legend.addTo(map);

  // 現在地
  if(L.control.locate){ L.control.locate({position:'topleft',flyTo:true,strings:{title:'現在地を表示'},locateOptions:{enableHighAccuracy:true}}).addTo(map); }
}
</script>
</body>
</html>
